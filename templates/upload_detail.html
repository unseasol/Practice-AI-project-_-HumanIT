{% extends "base.html" %}
{% block content %}
<h2>ğŸ” ì—…ë¡œë“œ ìƒì„¸ #{{ meta.id }}</h2>

<div class="mb-2">
  <b>íŒŒì¼ëª…:</b> {{ meta.filename or 'â€”' }}<br/>
  <b>ì—…ë¡œë“œ ì‹œê°(UTC):</b> {{ meta.uploaded_at }}<br/>
  <b>ì´ í–‰:</b> {{ meta.total_rows }},
  <b>ì•…ì„±:</b> {{ meta.malicious_rows }},
  <b>ë¹„ìœ¨:</b> {{ (meta.malicious_ratio*100)|round(2) }}%
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px 0;align-items:start;">
  <div>
    <h4>ì •ìƒ/ì•…ì„±</h4>
    <!-- ê³ ì • ë†’ì´ ë˜í¼ -->
    <div class="chart-box"><canvas id="pie"></canvas></div>
  </div>
  <div>
    <h4>ì•…ì„± ìœ í˜• ìƒìœ„</h4>
    <!-- ê³ ì • ë†’ì´ ë˜í¼ -->
    <div class="chart-box"><canvas id="bar"></canvas></div>
  </div>
</div>


<hr/>

<h4 class="mt-3">ìƒìœ„ ì•…ì„± Top 10</h4>
<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>duration</th>
      <th>protocol</th>
      <th>src_bytes</th>
      <th>dst_bytes</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
  {% for r in (details.top_malicious or []) %}
    <tr>
      <td>{{ r.duration }}</td>
      <td>{{ r.protocol }}</td>
      <td>{{ r.src_bytes }}</td>
      <td>{{ r.dst_bytes }}</td>
      <td>{{ r.prediction }}</td>
    </tr>
  {% endfor %}
  {% if not details.top_malicious %}
    <tr><td colspan="5" class="text-muted text-center">ëŒ€ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
  {% endif %}
  </tbody>
</table>

<!-- [CHANGE] ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ -->
<div class="detail-actions mt-3">
  <a class="btn-nav btn-back"
     href="{{ url_for('mypage', page=request.args.get('page', 1)) }}">
    ëª©ë¡ìœ¼ë¡œ
  </a>
</div>
{% endblock %}

{% block scripts %}
<script>
  // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°ì´í„°
  const totals  = {{ totals  | tojson | safe }};
  const byClass = {{ by_class | tojson | safe }};

  // íŒŒì´ì°¨íŠ¸
  new Chart(document.getElementById('pie'), {
    type: 'doughnut',
    data: {
      labels: ['Normal', 'Malicious'],
      datasets: [{ data: [totals.normal || 0, totals.malicious || 0] }]
    },
    options: { responsive:true, maintainAspectRatio:false }
  });

  // ë§‰ëŒ€ì°¨íŠ¸ (ìƒìœ„ 8ê°œ)
  const entries = Object.entries(byClass || {}).sort((a,b)=>b[1]-a[1]).slice(0,8);
  new Chart(document.getElementById('bar'), {
    type: 'bar',
    data: {
      labels: entries.map(e=>e[0]),
      datasets: [{ label:'count', data: entries.map(e=>e[1]) }]
    },
    options: { indexAxis:'y', responsive:true, maintainAspectRatio:false }
  });
</script>
{% endblock %}
