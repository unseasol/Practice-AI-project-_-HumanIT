{% extends "base.html" %}
{% block content %}
<h2>ğŸ“‚ ë‚´ ìœ„í˜‘ë¶„ì„ ê¸°ë¡</h2>

<!-- ìš”ì•½ ì¹´ë“œ -->
<div style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:12px 0;">
  <div class="card p-3"><b>ì´ ì—…ë¡œë“œ</b><div>{{ summary.total_uploads | comma }}</div></div>
  <div class="card p-3"><b>ì´ í–‰ìˆ˜</b><div>{{ summary.total_rows | comma }}</div></div>
  <div class="card p-3"><b>ëˆ„ì  ì•…ì„±</b><div>{{ summary.total_mal | comma }}</div></div>
  <div class="card p-3"><b>í‰ê·  ì•…ì„± ë¹„ìœ¨</b><div>{{ (summary.avg_ratio*100)|round(2) }}%</div></div>
</div>
<p class="text-muted">ìµœê·¼ ì—…ë¡œë“œ: {{ summary.last_time or 'â€”' }}</p>

<!-- ì°¨íŠ¸ -->
<!-- ì°¨íŠ¸ -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:start;">
  <div>
    <h4>ì „ì²´ ì •ìƒ/ì•…ì„±</h4>
    <div class="chart-box"><canvas id="pie"></canvas></div>
  </div>
  <div>
    <h4>ì•…ì„± ìœ í˜• ìƒìœ„</h4>
    <div class="chart-box"><canvas id="bar"></canvas></div>
  </div>
</div>


<hr/>

<!-- ì—…ë¡œë“œ ëª©ë¡ -->
<h4 class="mt-3">ì—…ë¡œë“œ íˆìŠ¤í† ë¦¬</h4>
<table class="table table-striped table-hover">
  <thead>
    <tr>
      <th>ID</th>
      <th>ì—…ë¡œë“œ ì‹œê°</th>
      <th>íŒŒì¼ëª…</th>
      <th>ì´ í–‰</th>
      <th>ì•…ì„±</th>
      <th>ë¹„ìœ¨</th>
    </tr>
  </thead>
  <tbody>
  {% for r in logs %}
    <tr>
      <td><a href="{{ url_for('upload_detail', upload_id=r.id) }}">{{ r.id }}</a></td>
      <td>{{ r.uploaded_at_fmt }}</td>
      <td>{{ r.filename or 'â€”' }}</td>
      <td>{{ r.total_rows }}</td>
      <td>{{ r.malicious_rows }}</td>
      <td>{{ (r.malicious_ratio*100)|round(2) }}%</td>
    </tr>
  {% endfor %}
  {% if logs|length == 0 %}
    <tr><td colspan="6" class="text-muted text-center">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
  {% endif %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ì„œë²„ ë°ì´í„° (Jinja â†’ JS ì•ˆì „ ë³€í™˜)
  const normalVal    = {{ summary.total_normal | tojson | safe }};
  const maliciousVal = {{ summary.total_mal    | tojson | safe }};
  const byClassData  = {{ by_class             | tojson | safe }};

  // ìº”ë²„ìŠ¤
  const pieEl = document.getElementById('pie');
  const barEl = document.getElementById('bar');

  // ê°€ë“œ: Chart.js ë¡œë“œ ì—¬ë¶€
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded. Check base.html script order.');
    return;
  }

  // -------- íŒŒì´(ë„ë„›) --------
  (function renderPie() {
    const total = (Number(normalVal) || 0) + (Number(maliciousVal) || 0);

    if (!pieEl) return;

    if (total === 0) {
      // ë°ì´í„° ì—†ì„ ë•Œ ì•ˆë‚´ ë¬¸êµ¬
      const ctx = pieEl.getContext('2d');
      ctx.clearRect(0, 0, pieEl.width, pieEl.height);
      ctx.font = '16px sans-serif';
      ctx.fillStyle = '#00ff41';
      ctx.textAlign = 'center';
      ctx.fillText('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', pieEl.width / 2, pieEl.height / 2);
      return;
    }

    new Chart(pieEl, {
      type: 'doughnut',
      data: {
        labels: ['Normal', 'Malicious'],
        datasets: [{
          data: [Number(normalVal) || 0, Number(maliciousVal) || 0],
          backgroundColor: ['#00c853', '#ff1744'],
          borderColor: ['#00c853', '#ff1744'],
          borderWidth: 1.5,
          hoverOffset: 4
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  })();

  // -------- ë§‰ëŒ€ --------
  (function renderBar() {
    if (!barEl) return;

    const entries = Object.entries(byClassData || {})
      .map(([k, v]) => [String(k), Number(v) || 0])
      .filter(([, v]) => v > 0)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 8);

    if (entries.length === 0) {
      const ctx = barEl.getContext('2d');
      ctx.clearRect(0, 0, barEl.width, barEl.height);
      ctx.font = '16px sans-serif';
      ctx.fillStyle = '#00ff41';
      ctx.textAlign = 'center';
      ctx.fillText('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', barEl.width / 2, barEl.height / 2);
      return;
    }

    new Chart(barEl, {
      type: 'bar',
      data: {
        labels: entries.map(e => e[0]),
        datasets: [{
          label: 'count',
          data: entries.map(e => e[1]),
          backgroundColor: ['#ff1744', '#0dcaf0', '#6f42c1', '#d63384'
          , '#dc3545', '#fd7e14', '#ffc107', '#20c997']
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#00ff41' }, grid: { color: 'rgba(0,255,65,.12)' } },
          y: { ticks: { color: '#00ff41' }, grid: { color: 'rgba(0,255,65,.08)' } }
        }
      }
    });
  })();
});
</script>
{% endblock %}
